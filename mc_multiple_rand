document.addEventListener("DOMContentLoaded", function () {

  function shuffle(arr){
    for(let i = arr.length - 1; i > 0; i--){
      let j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function normalize(s){
    return (s || "").trim().toLowerCase();
  }

  // Decode last__ingen_af_ovenstaaende -> "ingen af ovenstaaende"
  function decodeLastToken(token){
    return token.replace(/^last__/, "").replace(/_/g, " ");
  }

  document.querySelectorAll(".mc_multiple_rand").forEach(function(item){

    let container = item.querySelector(".mc-table");
    if(!container) return;

    let options = Array.from(container.querySelectorAll(".checkbox"));
    if(options.length < 2) return;

    // Read keep-last rules from class list
    let keepLastNeedles = Array.from(item.classList)
      .filter(c => c.indexOf("last__") === 0)
      .map(decodeLastToken)
      .map(normalize);

    let fixed = [];
    let shuffleThese = [];

    options.forEach(function(opt){
      let text = normalize(opt.innerText);

      let matchedIndex = keepLastNeedles.findIndex(function(k){
        return k && text.indexOf(k) !== -1;
      });

      if(matchedIndex >= 0){
        fixed.push({ node: opt, idx: matchedIndex });
      } else {
        shuffleThese.push(opt);
      }
    });

    shuffle(shuffleThese);

    // Respect order of last__ tokens
    fixed.sort(function(a,b){
      return a.idx - b.idx;
    });

    shuffleThese.forEach(function(opt){
      container.appendChild(opt);
    });

    fixed.forEach(function(x){
      container.appendChild(x.node);
    });

  });

});
